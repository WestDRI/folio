<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Solutions for Chapel course – Various courses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-a986a95301e671fce2c6472dffc862a1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      </li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"></a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel-compact.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Front page</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">PART 1: BASIC LANGUAGE FEATURES</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Chapel</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-02-variables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic syntax and variables + Julia set description</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-03-ranges-and-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ranges and arrays</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-04-control-flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Control flow</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-06-command-line-arguments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using command-line arguments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-07-timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Measuring code performance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-08-output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Writing output</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">PART 2: DATA PARALLELISM</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-10-intro-parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to parallel computing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-11-single-locale-data-parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Single-locale data parallelism</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-13-multi-locale-chapel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-locale Chapel</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-14-domains-and-data-parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Domains and data parallelism</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-15-distributed-julia-set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallel Julia set</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-16-distributed-heat-transfer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Heat transfer solver on distributed domains + heat transfer description</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">PART 3: TASK PARALLELISM (BRIEFLY)</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-20-fire-and-forget-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fire-and-forget tasks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-21-synchronising-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Synchronization of tasks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapel2/chapel-22-task-parallel-heat-transfer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Task-parallelizing the heat transfer solver</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">PART 4: GPU COMPUTING WITH CHAPEL</span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#part-1-basic-language-features" id="toc-part-1-basic-language-features" class="nav-link active" data-scroll-target="#part-1-basic-language-features">Part 1: basic language features</a>
  <ul class="collapse">
  <li><a href="#solution-to-basic.1" id="toc-solution-to-basic.1" class="nav-link" data-scroll-target="#solution-to-basic.1">Solution to “Basic.1”</a></li>
  <li><a href="#solution-to-basic.2" id="toc-solution-to-basic.2" class="nav-link" data-scroll-target="#solution-to-basic.2">Solution to “Basic.2”</a></li>
  <li><a href="#solution-to-basic.3" id="toc-solution-to-basic.3" class="nav-link" data-scroll-target="#solution-to-basic.3">Solution to “Basic.3”</a></li>
  <li><a href="#solution-to-basic.4" id="toc-solution-to-basic.4" class="nav-link" data-scroll-target="#solution-to-basic.4">Solution to “Basic.4”</a></li>
  <li><a href="#solution-to-basic.5" id="toc-solution-to-basic.5" class="nav-link" data-scroll-target="#solution-to-basic.5">Solution to “Basic.5”</a></li>
  </ul></li>
  <li><a href="#part-2-task-parallelism" id="toc-part-2-task-parallelism" class="nav-link" data-scroll-target="#part-2-task-parallelism">Part 2: task parallelism</a>
  <ul class="collapse">
  <li><a href="#solution-to-task.1" id="toc-solution-to-task.1" class="nav-link" data-scroll-target="#solution-to-task.1">Solution to “Task.1”</a></li>
  <li><a href="#solution-to-task.2" id="toc-solution-to-task.2" class="nav-link" data-scroll-target="#solution-to-task.2">Solution to “Task.2”</a></li>
  <li><a href="#solution-to-task.3" id="toc-solution-to-task.3" class="nav-link" data-scroll-target="#solution-to-task.3">Solution to “Task.3”</a></li>
  <li><a href="#solution-to-task.4" id="toc-solution-to-task.4" class="nav-link" data-scroll-target="#solution-to-task.4">Solution to “Task.4”</a></li>
  <li><a href="#solution-to-task.5" id="toc-solution-to-task.5" class="nav-link" data-scroll-target="#solution-to-task.5">Solution to “Task.5”</a></li>
  </ul></li>
  <li><a href="#part-3-data-parallelism" id="toc-part-3-data-parallelism" class="nav-link" data-scroll-target="#part-3-data-parallelism">Part 3: data parallelism</a>
  <ul class="collapse">
  <li><a href="#solution-to-data.1" id="toc-solution-to-data.1" class="nav-link" data-scroll-target="#solution-to-data.1">Solution to “Data.1”</a></li>
  <li><a href="#solution-to-data.2" id="toc-solution-to-data.2" class="nav-link" data-scroll-target="#solution-to-data.2">Solution to “Data.2”</a></li>
  <li><a href="#solution-to-data.3" id="toc-solution-to-data.3" class="nav-link" data-scroll-target="#solution-to-data.3">Solution to “Data.3”</a></li>
  <li><a href="#solution-to-data.4" id="toc-solution-to-data.4" class="nav-link" data-scroll-target="#solution-to-data.4">Solution to “Data.4”</a></li>
  <li><a href="#solution-to-data.5" id="toc-solution-to-data.5" class="nav-link" data-scroll-target="#solution-to-data.5">Solution to “Data.5”</a></li>
  <li><a href="#solution-to-data.6" id="toc-solution-to-data.6" class="nav-link" data-scroll-target="#solution-to-data.6">Solution to “Data.6”</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Solutions for Chapel course</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="part-1-basic-language-features" class="level2">
<h2 class="anchored" data-anchor-id="part-1-basic-language-features">Part 1: basic language features</h2>
<section id="solution-to-basic.1" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-basic.1">Solution to “Basic.1”</h3>
<p>To see the evolution of the temperature at the top right corner of the plate, we just need to modify <code>iout</code> and <code>jout</code>. This corner correspond to the first row (<code>iout=1</code>) and the last column (<code>jout=cols</code>) of the plate.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl baseSolver.chpl <span class="at">-o</span> baseSolver</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbatch serial.sh</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tail <span class="at">-f</span> solution.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Temperature at iteration 0: 25.0
Temperature at iteration 20: 1.48171
Temperature at iteration 40: 0.767179
...
Temperature at iteration 460: 0.068973
Temperature at iteration 480: 0.0661081
Temperature at iteration 500: 0.0634717</code></pre>
</section>
<section id="solution-to-basic.2" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-basic.2">Solution to “Basic.2”</h3>
<p>To get the linear distribution, the 80 degrees must be divided by the number of rows or columns in our plate. So, the following couple of for loops at the start of time iteration will give us what we want:</p>
<pre class="chpl"><code>// boundary conditions
for i in 1..rows do
  T[i,cols+1] = i*80.0/rows;   // right side
for j in 1..cols do
  T[rows+1,j] = j*80.0/cols;   // bottom side</code></pre>
<p>Note that 80 degrees is written as a real number 80.0. The division of integers in Chapel returns an integer, then, as <code>rows</code> and <code>cols</code> are integers, we must have 80 as real so that the result is not truncated.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl baseSolver.chpl <span class="at">-o</span> baseSolver</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbatch serial.sh</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tail <span class="at">-f</span> solution.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Temperature at iteration 0: 25.0
Temperature at iteration 20: 2.0859
Temperature at iteration 40: 1.42663
...
Temperature at iteration 460: 0.826941
Temperature at iteration 480: 0.824959
Temperature at iteration 500: 0.823152</code></pre>
</section>
<section id="solution-to-basic.3" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-basic.3">Solution to “Basic.3”</h3>
<p>The idea is simple: after each iteration of the while loop, we must compare all elements of <code>Tnew</code> and <code>T</code>, find the greatest difference, and update <code>delta</code> with that value. The following nested <code>for</code> loops should do the job:</p>
<pre class="chpl"><code>// update delta, the greatest difference between Tnew and T
delta = 0;
for i in 1..rows do {
  for j in 1..cols do {
    tmp = abs(Tnew[i,j] - T[i,j]);
    if tmp &gt; delta then delta = tmp;
  }
}</code></pre>
<p>Clearly there is no need to keep the difference at every single position in the array, we just need to update <code>delta</code> if we find a greater one.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl baseSolver.chpl <span class="at">-o</span> baseSolver</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbatch serial.sh</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tail <span class="at">-f</span> solution.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Temperature at iteration 0: 25.0
Temperature at iteration 20: 2.0859
Temperature at iteration 40: 1.42663
...
Temperature at iteration 460: 0.826941
Temperature at iteration 480: 0.824959
Temperature at iteration 500: 0.823152</code></pre>
</section>
<section id="solution-to-basic.4" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-basic.4">Solution to “Basic.4”</h3>
<p>For example, lets use a 650 x 650 grid and observe the evolution of the temperature at the position (200,300) for 10000 iterations or until the difference of temperature between iterations is less than 0.002; also, let’s print the temperature every 1000 iterations.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl <span class="at">--fast</span> baseSolver.chpl <span class="at">-o</span> baseSolver</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./baseSolver <span class="at">--rows</span><span class="op">=</span>650 <span class="at">--cols</span><span class="op">=</span>650 <span class="at">--iout</span><span class="op">=</span>200 <span class="at">--jout</span><span class="op">=</span>300 <span class="at">--niter</span><span class="op">=</span>10000 <span class="at">--tolerance</span><span class="op">=</span>0.002 <span class="at">--nout</span><span class="op">=</span>1000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Temperature at iteration 0: 25.0
Temperature at iteration 1000: 25.0
Temperature at iteration 2000: 25.0
Temperature at iteration 3000: 25.0
Temperature at iteration 4000: 24.9998
Temperature at iteration 5000: 24.9984
Temperature at iteration 6000: 24.9935
Temperature at iteration 7000: 24.9819
Final temperature at the desired position after 7750 iterations is: 24.9671
The greatest difference in temperatures between the last two iterations was: 0.00199985</code></pre>
</section>
<section id="solution-to-basic.5" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-basic.5">Solution to “Basic.5”</h3>
<p>Without <code>--fast</code> the calculation will become slower by ~95X.</p>
</section>
</section>
<section id="part-2-task-parallelism" class="level2">
<h2 class="anchored" data-anchor-id="part-2-task-parallelism">Part 2: task parallelism</h2>
<section id="solution-to-task.1" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-task.1">Solution to “Task.1”</h3>
<p>The following code is a possible solution:</p>
<pre class="chpl"><code>var x = 1;
config var numthreads = 2;
var messages: [1..numthreads] string;
writeln('This is the main thread: x = ', x);
coforall threadid in 1..numthreads do {
  var c = threadid**2;
  messages[threadid] = 'this is thread ' + threadid:string + ': my value of c is ' + c:string + ' and x is ' + x:string;  // add to a string
}
writeln('This message will not appear until all threads are done ...');
for i in 1..numthreads do  // serial loop, will be printed in sequential order
  writeln(messages[i]);</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl consecutive.chpl <span class="at">-o</span> consecutive</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sed <span class="at">-i</span> <span class="at">-e</span> <span class="st">'s|coforall --numthreads=5|consecutive --numthreads=5|'</span> shared.sh</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbatch shared.sh</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat solution.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>This is the main thread: x = 10
This message will not appear until all threads are done ...
this is thread 1: my value of c is 1 and x is 10
this is thread 2: my value of c is 4 and x is 10
this is thread 3: my value of c is 9 and x is 10
this is thread 4: my value of c is 16 and x is 10
this is thread 5: my value of c is 25 and x is 10</code></pre>
</section>
<section id="solution-to-task.2" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-task.2">Solution to “Task.2”</h3>
<pre class="chpl"><code>config const numthreads = 12;     // let's pretend we have 12 cores
const n = nelem / numthreads;     // number of elements per thread
const r = nelem - n*numthreads;   // these did not fit into the last thread
var lmax: [1..numthreads] real;   // local maximum for each thread

coforall threadid in 1..numthreads do {   // each iteration processed by a separate thread
  var start, finish: int;
  start  = (threadid-1)*n + 1;
  finish = (threadid-1)*n + n;
  if threadid == numthreads then finish += r;    // add r elements to the last thread
  for i in start..finish do
    if x[i] &gt; lmax[threadid] then lmax[threadid] = x[i];
 }

for threadid in 1..numthreads do     // no need for a parallel loop here
  if lmax[threadid] &gt; gmax then gmax = lmax[threadid];
</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl <span class="at">--fast</span> gmax.chpl <span class="at">-o</span> gmax</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sed <span class="at">-i</span> <span class="at">-e</span> <span class="st">'s|coforall --numthreads=5|gmax|'</span> shared.sh</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbatch shared.sh</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat solution.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>the maximum value in x is: 1.0</code></pre>
<p>We use <code>coforall</code> to spawn threads that work concurrently in a fraction of the array. The trick here is to determine, based on the <em>threadid</em>, the initial and final indices that the thread will use. Each thread obtains the maximum in its fraction of the array, and finally, after the coforall is done, the main thread obtains the maximum of the array from the maximums of all threads.</p>
</section>
<section id="solution-to-task.3" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-task.3">Solution to “Task.3”</h3>
<pre class="chpl"><code>var x = 0;
writeln('This is the main thread, my value of x is ', x);

sync {
  begin {
     var x = 5;
     writeln('this is thread 1, my value of x is ', x);
  }
  begin writeln('this is thread 2, my value of x is ', x);
}

writeln('this message will not appear until all threads are done...');</code></pre>
</section>
<section id="solution-to-task.4" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-task.4">Solution to “Task.4”</h3>
<p>The code most likely will lock (although sometimes it might not), as we’ll be hitting a race condition. Refer to the diagram for explanation.</p>
</section>
<section id="solution-to-task.5" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-task.5">Solution to “Task.5”</h3>
<p>You need two separate locks, and for simplicity increment them both:</p>
<pre class="chpl"><code>var lock1, lock2: atomic int;
const numthreads = 5;
lock1.write(0);   // the main thread set lock to zero
lock2.write(0);   // the main thread set lock to zero
coforall id in 1..numthreads {
  writeln('greetings form thread ', id, '... I am waiting for all threads to say hello');
  lock1.add(1);              // thread id says hello and atomically adds 1 to lock
  lock1.waitFor(numthreads);   // then it waits for lock=numthreads (which will happen when all threads say hello)
  writeln('thread ', id, ' is done ...');
  lock2.add(1);
  lock2.waitFor(numthreads);
  writeln('thread ', id, ' is really done ...');
}</code></pre>
</section>
</section>
<section id="part-3-data-parallelism" class="level2">
<h2 class="anchored" data-anchor-id="part-3-data-parallelism">Part 3: data parallelism</h2>
<section id="solution-to-data.1" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-data.1">Solution to “Data.1”</h3>
<p>Change the line</p>
<pre class="chpl"><code>for i in 1..n {</code></pre>
<p>to</p>
<pre class="chpl"><code>forall i in 1..n with (+ reduce total) {</code></pre>
</section>
<section id="solution-to-data.2" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-data.2">Solution to “Data.2”</h3>
<p>Run the code with</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./test <span class="at">-nl</span> 4 <span class="at">--n</span><span class="op">=</span>3</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./test <span class="at">-nl</span> 4 <span class="at">--n</span><span class="op">=</span>20</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For n=3 we get fewer threads (7 in my case), for n=20 we still get 12 threads (the maximum available number of cores inside our job).</p>
</section>
<section id="solution-to-data.3" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-data.3">Solution to “Data.3”</h3>
<p>Something along the lines of <code>m = here.id:string + '-' + m.locale.id:string;</code> should work.</p>
<p>In most cases <code>m.locale.id</code> should be the same as <code>here.id</code> (computation follows data distribution).</p>
</section>
<section id="solution-to-data.4" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-data.4">Solution to “Data.4”</h3>
<p>It should be <code>forall (i,j) in largerMesh[1..rows,1..cols] do</code> (run on multiple locales in parallel) instead of <code>forall (i,j) in mesh do</code> (run in parallel on locale 0 only).</p>
<p>Another possible solution is <code>forall (i,j) in Tnew.domain[1..rows,1..cols] do</code> (run on multiple locales in parallel).</p>
<p>Also, we cannot have <code>forall (i,j) in largerMesh do</code> (run in parallel on multiple locales) as this would overwrite the boundaries.</p>
</section>
<section id="solution-to-data.5" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-data.5">Solution to “Data.5”</h3>
<p>Just before temperature output (if count%nout == 0), insert the following:</p>
<pre class="chpl"><code>  var total = 0.0;
  forall (i,j) in largerMesh[1..rows,1..cols] with (+ reduce total) do
    total += T[i,j];</code></pre>
<p>and add total to the temperature output. It is decreasing as energy is leaving the system:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl <span class="at">--fast</span> parallel3.chpl <span class="at">-o</span> parallel3</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./parallel3 <span class="at">-nl</span> 1 <span class="at">--rows</span><span class="op">=</span>30 <span class="at">--cols</span><span class="op">=</span>30 <span class="at">--niter</span><span class="op">=</span>2000   <span class="co"># run this from inside distributed.sh</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Temperature</span> at iteration 0: 25.0</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Temperature</span> at iteration 20: 3.49566   21496.5</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Temperature</span> at iteration 40: 2.96535   21052.6</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Temperature</span> at iteration 1100: 2.5809   18609.5</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Temperature</span> at iteration 1120: 2.58087   18608.6</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Temperature</span> at iteration 1140: 2.58085   18607.7</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Final</span> temperature at the desired position <span class="pp">[</span><span class="ss">1,30</span><span class="pp">]</span> after 1148 iterations is: 2.58084</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> largest temperature difference was 9.9534e-05</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> simulation took 0.114942 seconds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="solution-to-data.6" class="level3">
<h3 class="anchored" data-anchor-id="solution-to-data.6">Solution to “Data.6”</h3>
<p>Here is one possible solution examining the locality of the finite-difference stencil:</p>
<pre class="chpl"><code>var message: [largerMesh] string = 'empty';</code></pre>
<p>and in the next line after computing Tnew[i,j] put</p>
<pre class="chpl"><code>    message[i,j] = "%i".format(here.id) + message[i,j].locale.id + message[i-1,j].locale.id +
      message[i+1,j].locale.id + message[i,j-1].locale.id + message[i,j+1].locale.id + '  ';</code></pre>
<p>and before the end of the <code>while</code> loop</p>
<pre class="chpl"><code>  writeln(message);
  assert(1&gt;2);</code></pre>
<p>Then run it</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chpl <span class="at">--fast</span> parallel3.chpl <span class="at">-o</span> parallel3</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./parallel3 <span class="at">-nl</span> 4 <span class="at">--rows</span><span class="op">=</span>8 <span class="at">--cols</span><span class="op">=</span>8   <span class="co"># run this from inside distributed.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/WestDRI\.github\.io\/folio\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>