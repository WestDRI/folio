<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Julia language – Various courses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-4df3b0c4fafa0f66eafcead0ee6cff11.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../julia1/julia-01-intro-language.html">PART 1</a></li><li class="breadcrumb-item"><a href="../julia1/julia-01-intro-language.html">Introduction to Julia language</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../"></a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia-menu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Front page</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">PART 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-01-intro-language.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Introduction to Julia language</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-02-intro-parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-03-threads-slow-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-threading with Base.Threads (slow series)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-04-threadsx-slow-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-threading with ThreadsX (slow series)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-05-threads-julia-set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the Julia set with Base.Threads</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-06-threadsx-julia-set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the Julia set with ThreadsX</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">PART 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-07-distributed1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed.jl: basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-08-distributed2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed.jl: three scalable versions of the slow series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-09-persistent-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Persistent storage on workers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-10-distributed-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DistributedArrays.jl</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-11-distributed-julia-set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the Julia set with DistributedArrays</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-12-shared-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SharedArrays.jl</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">SUPPLEMENTAL MATERIALS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-13-nbody.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the N-body problem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-14-asm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the additive Schwarz method</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-15-linear-algebra.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed linear algebra in Julia</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-julia-programming-language" id="toc-the-julia-programming-language" class="nav-link active" data-scroll-target="#the-julia-programming-language">The Julia programming language</a></li>
  <li><a href="#running-julia-locally" id="toc-running-julia-locally" class="nav-link" data-scroll-target="#running-julia-locally">Running Julia locally</a></li>
  <li><a href="#using-julia-on-supercomputers" id="toc-using-julia-on-supercomputers" class="nav-link" data-scroll-target="#using-julia-on-supercomputers">Using Julia on supercomputers</a>
  <ul class="collapse">
  <li><a href="#julia-on-the-alliance-production-clusters" id="toc-julia-on-the-alliance-production-clusters" class="nav-link" data-scroll-target="#julia-on-the-alliance-production-clusters">Julia on the Alliance production clusters</a></li>
  <li><a href="#julia-on-the-training-cluster-for-this-workshop" id="toc-julia-on-the-training-cluster-for-this-workshop" class="nav-link" data-scroll-target="#julia-on-the-training-cluster-for-this-workshop">Julia on the training cluster for this workshop</a></li>
  </ul></li>
  <li><a href="#running-julia-in-the-repl" id="toc-running-julia-in-the-repl" class="nav-link" data-scroll-target="#running-julia-in-the-repl">Running Julia in the REPL</a>
  <ul class="collapse">
  <li><a href="#where-to-run-the-repl" id="toc-where-to-run-the-repl" class="nav-link" data-scroll-target="#where-to-run-the-repl">Where to run the REPL</a></li>
  <li><a href="#repl-modes" id="toc-repl-modes" class="nav-link" data-scroll-target="#repl-modes">REPL modes</a></li>
  <li><a href="#repl-keybindings" id="toc-repl-keybindings" class="nav-link" data-scroll-target="#repl-keybindings">REPL keybindings</a></li>
  <li><a href="#repl-for-parallel-work" id="toc-repl-for-parallel-work" class="nav-link" data-scroll-target="#repl-for-parallel-work">REPL for parallel work</a></li>
  </ul></li>
  <li><a href="#running-scripts-as-batch-jobs" id="toc-running-scripts-as-batch-jobs" class="nav-link" data-scroll-target="#running-scripts-as-batch-jobs">Running scripts as batch jobs</a></li>
  <li><a href="#serial-julia-features-worth-noting-in-10-mins" id="toc-serial-julia-features-worth-noting-in-10-mins" class="nav-link" data-scroll-target="#serial-julia-features-worth-noting-in-10-mins">Serial Julia features worth noting in 10 mins</a>
  <ul class="collapse">
  <li><a href="#jit-compilation" id="toc-jit-compilation" class="nav-link" data-scroll-target="#jit-compilation">JIT compilation</a></li>
  <li><a href="#macros" id="toc-macros" class="nav-link" data-scroll-target="#macros">Macros</a></li>
  <li><a href="#fun-fact" id="toc-fun-fact" class="nav-link" data-scroll-target="#fun-fact">Fun fact</a></li>
  <li><a href="#additional-basic-information" id="toc-additional-basic-information" class="nav-link" data-scroll-target="#additional-basic-information">Additional basic information</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../julia1/julia-01-intro-language.html">PART 1</a></li><li class="breadcrumb-item"><a href="../julia1/julia-01-intro-language.html">Introduction to Julia language</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Introduction to Julia language</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="the-julia-programming-language" class="level2">
<h2 class="anchored" data-anchor-id="the-julia-programming-language">The Julia programming language</h2>
<ul>
<li>High-performance, dynamically typed programming language for scientific computing</li>
<li>Uses just-in-time (JIT) compiler to compile all code, includes an interactive command line (REPL = read–eval–print loop, and can also be run in Jupyter), i.e.&nbsp;tries to <strong>combine the advantages of both compiled and interpreted languages</strong></li>
<li>Built-in package manager</li>
<li>Lots of interesting design decisions, e.g.&nbsp;macros, support for Unicode, etc</li>
<li><strong>Support for parallel and distributed computing</strong> via its Standard Library and many 3rd party packages
<ul>
<li>being added along the way, e.g. <span class="citation" data-cites="threads">@threads</span> were first introduced in v0.5</li>
<li>currently under active development, both in features and performance</li>
</ul></li>
</ul>
</section>
<section id="running-julia-locally" class="level2">
<h2 class="anchored" data-anchor-id="running-julia-locally">Running Julia locally</h2>
<p>If you have Julia installed on your own computer, you can run it there: on a multi-core laptop/desktop you can launch multiple threads and processes and run them in parallel.</p>
<p>If you want to install Julia after this workshop, you can find it <a href="https://julialang.org/downloads" target="_blank">here</a>.</p>
</section>
<section id="using-julia-on-supercomputers" class="level2">
<h2 class="anchored" data-anchor-id="using-julia-on-supercomputers">Using Julia on supercomputers</h2>
<section id="julia-on-the-alliance-production-clusters" class="level3">
<h3 class="anchored" data-anchor-id="julia-on-the-alliance-production-clusters">Julia on the Alliance production clusters</h3>
<p>Julia is among hundreds of software packages installed on the Alliance clusters. To use Julia on one of them, you would load the following module:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> module spider julia   <span class="co"># show the available versions</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> module load julia     <span class="co"># load the default version</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="installing-julia-packages-on-a-production-cluster" class="level4">
<h4 class="anchored" data-anchor-id="installing-julia-packages-on-a-production-cluster">Installing Julia packages on a production cluster</h4>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Don’t do this on the training cluster! We already have everything installed in a central location for all guest accounts.</p>
</div>
</div>
<p>By default, all Julia packages you install from REPL will go into <code>$HOME/.julia</code>, and that we will count against your <code>/home</code> quota. If you want to put packages into another location, you will need to (1) install inside your Julia session with (from within Julia):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">empty!</span>(<span class="cn">DEPOT_PATH</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">push!</span>(<span class="cn">DEPOT_PATH</span>,<span class="st">"/scratch/path/to/julia/packages"</span>) </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>] add BenchmarkTools</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and (2) before running Julia modify two variables (from the command line):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> module load julia</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> export JULIA_DEPOT_PATH=/home/\$USER/.julia:/scratch/path/to/julia/packages</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> export JULIA_LOAD_PATH=@:@v#.#:@stdlib:/scratch/path/to/julia/packages</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some Julia packages rely on precompiled bits that developers think would work on all architectures, but they don’t. For example, <code>Plots</code> package comes with several precompiled libraries, it installs without problem on the Alliance clusters, but then at runtime you might see an error about “GLIBC_2.18 not found”. The proper solution would be to recompile the package on the cluster, but it is not done correctly in Julia packaging, and the error persists even after “recompilation”. There is a solution for this, and you can always contact us at support@tech.alliancecan.ca and ask for help. Another example is Julia’s <code>NetCDF</code> package: as of February 2022, it was installing fine on Apple Silicon Macs, but it came with a precompiled C package that had been compiled only for Intel Macs and did not work on M1. This issue has been resolved since then, but the point remains: successful installation of a Julia package does not mean it’ll work on your architecture.</p>
</div>
</div>
</section>
</section>
<section id="julia-on-the-training-cluster-for-this-workshop" class="level3">
<h3 class="anchored" data-anchor-id="julia-on-the-training-cluster-for-this-workshop">Julia on the training cluster for this workshop</h3>
<p>We have Julia on our training cluster <em>julia.vastcloud.org</em>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
Our training cluster has:
<ul>
<li>
one fairly small login node,
</li>
<li>
6 compute nodes with 8 cores and 30GB of memory on each &nbsp;⟹&nbsp; 3.75GB/core, 48 cores in total
</li>
</ul>
</div>
</div>
<p>Normally in our introductory Julia course we would use Julia inside a Jupyter notebook. Today we will be starting multiple threads and processes, with the eventual goal of running our workflows as batch jobs on an HPC cluster, so we’ll be using Julia from the command line.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Training cluster
</div>
</div>
<div class="callout-body-container callout-body">
<p>We will now distribute accounts and passwords to connect to the cluster.</p>
</div>
</div>
<p>Normally, you would install Julia packages yourself. A typical package installation however takes several hundred MBs of RAM, a fairly long time, and creates many small files. Our training cluster runs on top of virtualized hardware with a shared filesystem. If several dozen workshop participants start installing packages at the same time, this will hammer the filesystem and will make it slow for all participants for quite a while.</p>
<p>Instead, for this workshop, you will run:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> source /project/def-sponsor00/shared/julia/config/loadJulia.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This script loads the Julia module and sets environment variables to point to a central environment in which we have pre-installed all the packages for this workshop.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that you can still install additional packages if you want. These will install in your own environment at <code>~/.julia</code>.</p>
</div>
</div>
</section>
</section>
<section id="running-julia-in-the-repl" class="level2">
<h2 class="anchored" data-anchor-id="running-julia-in-the-repl">Running Julia in the REPL</h2>
<section id="where-to-run-the-repl" class="level3">
<h3 class="anchored" data-anchor-id="where-to-run-the-repl">Where to run the REPL</h3>
<p>You could now technically launch a Julia REPL (Read-Eval-Print-Loop). However, this would launch it on the login node and if everybody does this at the same time, we would probably crash our training cluster.</p>
<p>Instead, you will first launch an interactive job by running the Slurm command <code>salloc</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> salloc <span class="at">--mem-per-cpu</span><span class="op">=</span>3600M <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--time</span><span class="op">=</span>2:0:0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This puts you on a compute node and gives you 2 CPU cores for up to 2 hours.</p>
<p>Now you can launch the Julia REPL and try to run a couple of commands:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> julia</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>               <span class="ex">_</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>   <span class="ex">_</span>       _ _<span class="er">(</span><span class="ex">_</span><span class="kw">)</span><span class="ex">_</span>     <span class="kw">|</span>  <span class="ex">Documentation:</span> https://docs.julialang.org</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">_</span><span class="kw">)</span>     <span class="kw">|</span> <span class="kw">(</span><span class="ex">_</span><span class="kw">)</span> <span class="kw">(</span><span class="ex">_</span><span class="kw">)</span>    <span class="kw">|</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>   <span class="ex">_</span> _   _<span class="kw">|</span> <span class="kw">|</span><span class="ex">_</span>  __ _   <span class="kw">|</span>  <span class="ex">Type</span> <span class="st">"?"</span> for help, <span class="st">"]?"</span> for Pkg help.</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span><span class="ex">/</span> _<span class="kw">`</span> <span class="kw">|</span>  <span class="kw">|</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span><span class="ex">_</span><span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span> <span class="kw">(</span><span class="ex">_</span><span class="kw">|</span> <span class="kw">|</span>  <span class="kw">|</span>  <span class="ex">Version</span> 1.8.5 <span class="er">(</span><span class="ex">2023-01-08</span><span class="kw">)</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">_/</span> <span class="kw">|</span><span class="ex">\__</span><span class="st">'_|_|_|\__'</span><span class="ex">_</span><span class="kw">|</span>  <span class="kw">|</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">__/</span>                   <span class="kw">|</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="ex">julia</span><span class="op">&gt;</span> using BenchmarkTools</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">julia</span><span class="op">&gt;</span> @btime sqrt<span class="er">(</span><span class="ex">2</span><span class="kw">)</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">1.310</span> ns <span class="er">(</span><span class="ex">0</span> allocations: 0 bytes<span class="kw">)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="ex">1.4142135623730951</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="repl-modes" class="level3">
<h3 class="anchored" data-anchor-id="repl-modes">REPL modes</h3>
<p>The Julia REPL has 4 modes:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">julia</span><span class="op">&gt;</span>       Julian mode to run code. Default mode. Go back to it from other modes with Backspace</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">help</span><span class="pp">?</span><span class="op">&gt;</span>       Help mode to access documentation. Enter it with <span class="pp">?</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">shell</span><span class="op">&gt;</span>       Shell mode to run Bash commands. Enter it with <span class="kw">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">env</span><span class="kw">)</span> <span class="ex">pkg</span><span class="op">&gt;</span>   Package manager mode to manage external packages. Enter it with ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(<code>env</code> is the name of your current project environment.)</p>
</section>
<section id="repl-keybindings" class="level3">
<h3 class="anchored" data-anchor-id="repl-keybindings">REPL keybindings</h3>
<p>In the REPL, you can use standard command-line (Emacs-like) keybindings:</p>
<pre><code>C-c     cancel
C-d     quit
C-l     clear console

C-u     kill from the start of line
C-k     kill until the end of line

C-a     go to start of line
C-e     go to end of line

C-f     move forward one character
C-b     move backward one character

M-f     move forward one word
M-b     move backward one word

C-d     delete forward one character
C-h     delete backward one character

M-d     delete forward one word
M-Backspace delete backward one word

C-p     previous command
C-n     next command

C-r     backward search
C-s     forward search</code></pre>
</section>
<section id="repl-for-parallel-work" class="level3">
<h3 class="anchored" data-anchor-id="repl-for-parallel-work">REPL for parallel work</h3>
<p>Remember our workflow to launch a Julia REPL:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 0: start tmux (optional), gives you left-right panes, persistent terminal session</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tmux</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: run the script to load our Julia environment with pre-installed packages</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> source /project/def-sponsor00/shared/julia/config/loadJulia.sh</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: launch an interactive job on a compute node</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> salloc <span class="at">--mem-per-cpu</span><span class="op">=</span>3600M <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--time</span><span class="op">=</span>2:0:0</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: launch the Julia REPL</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> julia</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will launch Julia in serial. To use multiple threads, you want to pass the <code>-t</code> flag when starting Julia:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch Julia on 2 threads</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> julia <span class="at">-t</span> 2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="running-scripts-as-batch-jobs" class="level2">
<h2 class="anchored" data-anchor-id="running-scripts-as-batch-jobs">Running scripts as batch jobs</h2>
<p>Now, if we want to get an even bigger speedup, we could use even more CPUs per task. The problem is that our training cluster only has ~60 compute cores, so if we use <code>--cpus-per-task=4</code> some of us could be left waiting for Slurm while the others play with several CPUs for two hours. This is not an efficient approach. This is equally true on production clusters: if you want to run an interactive job using a lot of resources, you might have to wait for a long time.</p>
<p>On production clusters, a much better approach is to put our Julia code in a Julia script and run it through a batch job by using the Slurm command <code>sbatch</code>.</p>
<!-- You can run a Julia script with `julia julia_script.jl`. -->
<!-- So all we need to do is to submit a shell script to `sbatch` that contains information for Slurm and the code to run (`julia julia_script.jl`). -->
<p>Let’s save the following into a file <code>job_script.sh</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --ntasks=1</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem-per-cpu=3600M</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=00:10:00</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ex">julia</span> <span class="at">-t</span> 4 julia_script.jl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we submit our job script:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbatch job_script.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this session, we continue using <code>salloc --cpus-per-task=2 ...</code></p>
</section>
<section id="serial-julia-features-worth-noting-in-10-mins" class="level2">
<h2 class="anchored" data-anchor-id="serial-julia-features-worth-noting-in-10-mins">Serial Julia features worth noting in 10 mins</h2>
<section id="jit-compilation" class="level3">
<h3 class="anchored" data-anchor-id="jit-compilation">JIT compilation</h3>
<p>Programming languages are either interpreted or compiled.</p>
<p>Interpreted languages use interpreters: programs that execute your code directly (Python, for instance, uses the interpreter CPython, written in C). Interpreted languages are very convenient since you can run sections of your code as soon as you write them. However, they are slow.</p>
<p>Compiled languages use compilers: programs that translate your code into machine code. Machine code is extremely efficient, but of course, having to compile your code before being able to run it makes for less convenient workflows when it comes to writing or debugging code.</p>
<p>Julia uses <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation" target="_blank">just-in-time compilation</a> or JIT based on <a href="https://en.wikipedia.org/wiki/LLVM" target="_blank">LLVM</a>: the source code is compiled at run time. This combines the flexibility of interpretation with the speed of compilation, bringing speed to an interactive language. It also allows for dynamic recompilation, continuous weighing of gains and costs of the compilation of parts of the code, and other on the fly optimizations.</p>
<p><a href="https://kipp.ly/blog/jits-intro" target="_blank">Here</a> is a great blog post covering this topic if you want to dive deeper into the functioning of JIT compilers.</p>
</section>
<section id="macros" class="level3">
<h3 class="anchored" data-anchor-id="macros">Macros</h3>
<p>In the tradition of Lisp, Julia has <a href="https://en.wikibooks.org/wiki/Introducing_Julia/Metaprogramming#Macros" target="_blank">strong metaprogramming capabilities</a>, in particular in the form of macros.</p>
<p>Macros are parsed and evaluated first, then their output gets evaluated like a classic expression. This allows the language to modify itself in a <a href="https://en.wikipedia.org/wiki/Reflective_programming" target="_blank">reflective</a> manner.</p>
<p>Macros have a <code>@</code> prefix and are defined with a syntax similar to that of functions.</p>
<p><code>@time</code> for instance is a macro that executes an expression and prints the execution time and other information.</p>
</section>
<section id="fun-fact" class="level3">
<h3 class="anchored" data-anchor-id="fun-fact">Fun fact</h3>
<p><a href="https://docs.julialang.org/en/v1/manual/unicode-input" target="_blank">Julia supports unicode</a>. In a Julia REPL, type <code>\:snail:</code> followed by the TAB key, and you get 🐌.</p>
<p>While assigning values to a “snail variable” might not be all that useful, a wide access to – for instance – Greek letters, would make Julia’s code look nicely similar to the equations it represents. For instance, if you type TAB after each variable name, the following:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">\</span>pgamma <span class="op">=</span> ((<span class="op">\</span>alpha <span class="op">\</span><span class="cn">pi</span> <span class="op">+</span> <span class="op">\</span>beta) <span class="op">/</span> <span class="op">\</span>delta) <span class="op">+</span> <span class="op">\</span>upepsilon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>looks like:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cn">ɣ</span> <span class="op">=</span> ((α <span class="cn">π</span> <span class="op">+</span> β) <span class="op">/</span> δ) <span class="op">+</span> ε</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In Julia you can omit the multiplication sign in some cases, e.g.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>julia<span class="op">&gt;</span> <span class="fl">2</span>π</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fl">6.283185307179586</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="additional-basic-information" class="level3">
<h3 class="anchored" data-anchor-id="additional-basic-information">Additional basic information</h3>
<p>Our beginner’s <a href="https://rcmodules22.netlify.app/programming_julia" target="_blank">introduction to Julia course</a> has, amongst others, sections on:</p>
<ul>
<li><a href="https://westgrid-julia.netlify.app/2022_modules/06_jl_pkg" target="_blank">working with packages</a></li>
<li><a href="https://westgrid-julia.netlify.app/2022_modules/08_jl_functions" target="_blank">working with functions</a></li>
<li><a href="https://westgrid-julia.netlify.app/2022_modules/09_jl_control_flow" target="_blank">control flow</a></li>
<li><a href="https://westgrid-julia.netlify.app/2022_modules/13_jl_arrays" target="_blank">arrays</a></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/folio\.vastcloud\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>