<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Parallelizing iterative additive Schwarz method – Various courses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-4df3b0c4fafa0f66eafcead0ee6cff11.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../julia1/julia-13-nbody.html">SUPPLEMENTAL MATERIALS</a></li><li class="breadcrumb-item"><a href="../julia1/julia-14-asm.html">Parallelizing the additive Schwarz method</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../"></a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia-menu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Front page</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">PART 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-01-intro-language.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Julia language</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-02-intro-parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-03-threads-slow-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-threading with Base.Threads (slow series)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-04-threadsx-slow-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-threading with ThreadsX (slow series)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-05-threads-julia-set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the Julia set with Base.Threads</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-06-threadsx-julia-set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the Julia set with ThreadsX</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">PART 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-07-distributed1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed.jl: basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-08-distributed2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed.jl: three scalable versions of the slow series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-09-persistent-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Persistent storage on workers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-10-distributed-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DistributedArrays.jl</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-11-distributed-julia-set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the Julia set with DistributedArrays</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-12-shared-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SharedArrays.jl</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">SUPPLEMENTAL MATERIALS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-13-nbody.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parallelizing the N-body problem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-14-asm.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Parallelizing the additive Schwarz method</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../julia1/julia-15-linear-algebra.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed linear algebra in Julia</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#serial-additive-schwarz-method-with-explicit-matrices" id="toc-serial-additive-schwarz-method-with-explicit-matrices" class="nav-link active" data-scroll-target="#serial-additive-schwarz-method-with-explicit-matrices">Serial additive Schwarz method with explicit matrices</a></li>
  <li><a href="#serial-additive-schwarz-method-with-structures" id="toc-serial-additive-schwarz-method-with-structures" class="nav-link" data-scroll-target="#serial-additive-schwarz-method-with-structures">Serial additive Schwarz method with structures</a></li>
  <li><a href="#parallel-additive-schwarz-method" id="toc-parallel-additive-schwarz-method" class="nav-link" data-scroll-target="#parallel-additive-schwarz-method">Parallel additive Schwarz method</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../julia1/julia-13-nbody.html">SUPPLEMENTAL MATERIALS</a></li><li class="breadcrumb-item"><a href="../julia1/julia-14-asm.html">Parallelizing the additive Schwarz method</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Parallelizing iterative additive Schwarz method</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this section we will implement the iterative additive Schwarz method (ASM) <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> in Julia, starting with a serial version. We will then parallelize it with DistributedArrays.jl.</p>
<p>We will be solving the 1D Poisson problem:</p>
<p><img src="../fig/e01.png" class="img-fluid" style="width:80.0%"></p>
<p>Discretizing this equation on a uniform grid of <span class="math inline">\(m\)</span> points, we have</p>
<p><img src="../fig/e02.png" class="img-fluid"></p>
<p>or in matrix notation <span class="math inline">\(AU=F\)</span>, where</p>
<p><img src="../fig/e03.png" class="img-fluid"></p>
<p>Let’s break our grid into two domains <span class="math inline">\(\Omega=\Omega_1\bigcup\Omega_2\)</span>, where we are looking for the solution</p>
<p><img src="../fig/e04.png" class="img-fluid" style="width:75.0%"></p>
<p>In matrix notation the solution can be written as <span class="math inline">\(U_i=R_iU\)</span>, where the <strong>restriction operator</strong> <span class="math inline">\(R_1\)</span> is a <span class="math inline">\(m_s\times
m\)</span> matrix consisting of two parts of sizes <span class="math inline">\(m_s\times m_s\)</span> and <span class="math inline">\(m_s\times(m-m_s)\)</span>, and <span class="math inline">\(R_2\)</span> is a <span class="math inline">\((m-m_s)\times m\)</span> matrix consisting of two parts of sizes <span class="math inline">\((m-m_s)\times m_s\)</span> and <span class="math inline">\((m-m_s)\times(m-m_s)\)</span>, respectively:</p>
<p><img src="../fig/e05.png" class="img-fluid"></p>
<p>The iterative additive Schwarz method (eq. 1.30 of <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>) lets you compute the next iteration of the solution as</p>
<p><img src="../fig/e06.png" class="img-fluid" style="width:75.0%"></p>
<p>where the matrix</p>
<p><img src="../fig/e07.png" class="img-fluid" style="width:80.0%"></p>
<p>is called the ASM preconditioner.</p>
<section id="serial-additive-schwarz-method-with-explicit-matrices" class="level3">
<h3 class="anchored" data-anchor-id="serial-additive-schwarz-method-with-explicit-matrices">Serial additive Schwarz method with explicit matrices</h3>
<p>Let’s generalize our computation to three 1D domains. For now, we are writing the serial code, so all arrays are local. Also in this first code, we will define matrices explicitly, even though <span class="math inline">\(A\)</span> is sparse, and <span class="math inline">\(R_i\)</span> are Boolean matrices. All these shortcomings will be corrected in the parallel code.</p>
<p>For matrix inversion <span class="math inline">\((R_iAT_i^T)^{-1}\)</span> we will use Julia’s builtin <code>inv()</code> function, but presumably for larger calculations you might want to replace this with your own (more efficient?) code.</p>
<!-- # 1. replace some matrices to Boolean or sparse -->
<!-- # 1. practical computing of inv() -->
<!-- # 1. parallelize -->
<p>For the right-hand side <span class="math inline">\(F\)</span>, we’ll use a constant piece in the middle, mimicking a uniform bar with empty spaces on each end.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="fl">21</span>               <span class="co"># total number of points</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="fl">3</span>                <span class="co"># number of domains</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>ms <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, N)   <span class="co"># number of points in each domain</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ms[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">=</span> [<span class="fl">7</span>,<span class="fl">7</span>]      <span class="co"># number of points in the first two domains, respectively</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>ms[<span class="fl">3</span>] <span class="op">=</span> m <span class="op">-</span> <span class="fu">sum</span>(ms)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> (m<span class="op">-</span><span class="fl">1</span>)      <span class="co"># grid spacing</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>U <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);   <span class="co"># 0th iteration</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>F <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);   <span class="co"># RHS</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>F[<span class="fu">trunc</span>(<span class="dt">Int</span>,m<span class="op">/</span><span class="fl">2</span>)<span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fu">trunc</span>(<span class="dt">Int</span>,m<span class="op">/</span><span class="fl">2</span>)<span class="op">+</span><span class="fl">3</span>] <span class="op">.=</span> h<span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="fl">1.0</span>;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, m);</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>A[<span class="fl">1</span>,<span class="fl">1</span>], A[m,m] <span class="op">=</span> <span class="fl">1</span>, <span class="fl">1</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>m<span class="op">-</span><span class="fl">1</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    A[i, i<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    A[i,i] <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    A[i, i<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>R1 <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int32</span>, ms[<span class="fl">1</span>], m);</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms[<span class="fl">1</span>]</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    R1[j,j] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>R2 <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int32</span>, ms[<span class="fl">2</span>], m);</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms[<span class="fl">2</span>]</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    R2[j,ms[<span class="fl">1</span>]<span class="op">+</span>j] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>R3 <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int32</span>, ms[<span class="fl">3</span>], m);</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms[<span class="fl">3</span>]</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    R3[j,ms[<span class="fl">1</span>]<span class="op">+</span>ms[<span class="fl">2</span>]<span class="op">+</span>j] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># compute three terms in the ASM preconditioner</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="fu">transpose</span>(R1) <span class="op">*</span> <span class="fu">inv</span>(<span class="fu">R1*A*transpose</span>(R1)) <span class="op">*</span> R1;</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>M <span class="op">+=</span> <span class="fu">transpose</span>(R2) <span class="op">*</span> <span class="fu">inv</span>(<span class="fu">R2*A*transpose</span>(R2)) <span class="op">*</span> R2;</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>M <span class="op">+=</span> <span class="fu">transpose</span>(R3) <span class="op">*</span> <span class="fu">inv</span>(<span class="fu">R3*A*transpose</span>(R3)) <span class="op">*</span> R3;</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span>: norm</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> iter <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    dU <span class="op">=</span> M <span class="op">*</span> (F<span class="op">-</span>A<span class="op">*</span>U)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> U <span class="op">+=</span> dU</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="fu">norm</span>(dU))</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>exact <span class="op">=</span> A <span class="op">\</span> F;   <span class="co"># Julia's left division, i.e. A^{-1}*F</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fl">1</span><span class="op">:</span>m, exact, label <span class="op">=</span> <span class="st">"exact"</span>)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">1</span><span class="op">:</span>m, U, label<span class="op">=</span><span class="st">"approximate"</span>)   <span class="co"># overplot</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="fu">savefig</span>(<span class="st">"serial.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="serial-additive-schwarz-method-with-structures" class="level3">
<h3 class="anchored" data-anchor-id="serial-additive-schwarz-method-with-structures">Serial additive Schwarz method with structures</h3>
<p>We will generalize our code to an arbitrary number of domains. Instead of using R1, R2, R3, we will define a structure <code>domainType</code> that will contain the restriction operator for each domain. It could contain other variables and matrices, but for now we don’t need any other elements in it.</p>
<p>Similar to the previous version of the code, here we are still storing all sparse and Boolean matrices as dense matrices, which is Ok only for testing purposes (for real problems these matrices will be large).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="fl">21</span>               <span class="co"># total number of points</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="fl">3</span>                <span class="co"># number of domains</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>ms <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, N)   <span class="co"># number of points in each domain</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ms[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">=</span> [<span class="fl">7</span>,<span class="fl">7</span>]      <span class="co"># number of points in the first two domains, respectively</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ms[<span class="fl">3</span>] <span class="op">=</span> m <span class="op">-</span> <span class="fu">sum</span>(ms)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> (m<span class="op">-</span><span class="fl">1</span>)      <span class="co"># grid spacing</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>U <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);   <span class="co"># 0th iteration; will be a distributed 2D array</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>F <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);   <span class="co"># RHS; will be a distributed 2D array</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>F[<span class="fu">trunc</span>(<span class="dt">Int</span>,m<span class="op">/</span><span class="fl">2</span>)<span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fu">trunc</span>(<span class="dt">Int</span>,m<span class="op">/</span><span class="fl">2</span>)<span class="op">+</span><span class="fl">3</span>] <span class="op">.=</span> h<span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="fl">1.0</span>;</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, m);</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>A[<span class="fl">1</span>,<span class="fl">1</span>], A[m,m] <span class="op">=</span> <span class="fl">1</span>, <span class="fl">1</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>m<span class="op">-</span><span class="fl">1</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    A[i, i<span class="op">-</span><span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    A[i,i] <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    A[i, i<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> domainType</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    R<span class="op">::</span><span class="dt">Array{Int32}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>domain <span class="op">=</span> <span class="fu">Array</span><span class="dt">{domainType, 1}</span>(<span class="cn">undef</span>, <span class="fl">3</span>)   <span class="co"># 3-element 1D array of domains</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, m);</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> [<span class="fl">0</span>, ms[<span class="fl">1</span>], ms[<span class="fl">1</span>]<span class="op">+</span>ms[<span class="fl">2</span>]];</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    domain[i] <span class="op">=</span> <span class="fu">domainType</span>(<span class="fu">zeros</span>(<span class="dt">Int32</span>, ms[i], m)) <span class="co"># construct a new object of domainType</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms[i]</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        domain[i].R[j,offset[i]<span class="op">+</span>j] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> M <span class="op">+=</span> <span class="fu">transpose</span>(domain[i].R) <span class="op">*</span> <span class="fu">inv</span>(domain[i].<span class="fu">R*A*transpose</span>(domain[i].R)) <span class="op">*</span> domain[i].R;</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span>: norm</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> iter <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    dU <span class="op">=</span> M <span class="op">*</span> (F<span class="op">-</span>A<span class="op">*</span>U)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> U <span class="op">+=</span> dU</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="fu">norm</span>(dU))</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>exact <span class="op">=</span> A <span class="op">\</span> F;</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fl">1</span><span class="op">:</span>m, exact, label <span class="op">=</span> <span class="st">"exact"</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">1</span><span class="op">:</span>m, U, label<span class="op">=</span><span class="st">"approximate"</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="fu">savefig</span>(<span class="st">"serial.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="parallel-additive-schwarz-method" class="level3">
<h3 class="anchored" data-anchor-id="parallel-additive-schwarz-method">Parallel additive Schwarz method</h3>
<!-- # complications: DArray of struct seems not possible in Julia, DArray of unbalanced partitions seems not possible in -->
<!-- # Julia (local DArray blocks must all have the same size), A*U does not work right now in Julia if U is distributed -->
<p>Imagine that now we are dealing with a very large problem, and we are breaking it into pieces, with each piece being processed by one worker. Now <span class="math inline">\(U\)</span> and <span class="math inline">\(F\)</span> will be 1D distributed arrays split between workers; we’ll implement them with distributed arrays.</p>
<p>Ideally, we would like to partition <code>domain</code> into subdomains with DistributedArrays.jl, and then on each processor use a combination of sparse and Boolean (coded explicitly with indices) matrices to solve the problem. However, at this point DistributedArrays.jl <strong>does not seem to support distributed arrays of structures</strong>.</p>
<p>At the heart of our implementation is the distributed preconditioner matrix <code>pre</code>. DistributedArrays.jl <strong>does not seem to support an uneven distribution of an array across processes</strong>, and therefore we are limited to having an equal number of points in all subdomains.</p>
<p><span class="math inline">\(A\)</span> is a sparse matrix. While Julia supports sparse matrices, instead we will code it algebraically with indices, so that we don’t have to worry about its distribution among processes.</p>
<p><span class="math inline">\(R_i\)</span> is Boolean. The matrix <span class="math inline">\(R_iAR_i^T\)</span> applies the domain restriction operator <span class="math inline">\(R_i\)</span> to both rows and columns of <span class="math inline">\(A\)</span>, and the result is coded algebraically with the function <code>fillPre()</code>. It is then inverted locally in each process with <code>invertPre()</code>.</p>
<p><span class="math inline">\(R_i^T\left(R_iAR_i^T\right)^{-1}R_i\)</span> takes the result of this inversion and puts it as a dense block into the <span class="math inline">\(m\times
m\)</span> ASM preconditioner <span class="math inline">\(M^{-1}_\textrm{ASM}\)</span>. Each process computes its own dense block and stores it locally inside the distributed preconditioner matrix <code>pre</code>.</p>
<p>Next, we start iterations. In <code>computeUpdate()</code> we compute <span class="math inline">\(F-AU^n\)</span> as a 1D distributed array <code>tmp</code>, and multiply the preconditioner <code>pre</code> by <code>tmp</code>. Since <code>pre</code> is block-diagonal, this multiplication can be done separately in each process. Finally, we call <code>addUpdate()</code> to update the distributed solution <code>U</code>, again separately in each process.</p>
<p><strong>Big assumptions</strong>:</p>
<ol type="1">
<li>All distributed arrays are partitioned in exactly the same way, i.e.&nbsp;the same range of indices is assigned to each worker for 1D arrays <code>U</code>, <code>tmp</code>, <code>dU</code>, <code>F</code>.</li>
<li>The 2D array <code>pre</code> is partitioned purely along the second dimension (columns), i.e.&nbsp;each worker gets an <span class="math inline">\(m_s\times
m_s\)</span> array, and the range of column indices on each worker is exactly the same as for the 1D arrays above.</li>
</ol>
<p>You can force (2) by replacing the line</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pre <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float64</span>, ms, m);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with the following block</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="op">=</span> <span class="pp">@spawnat</span> <span class="fl">2</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, ms, ms);</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>d2 <span class="op">=</span> <span class="pp">@spawnat</span> <span class="fl">3</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, ms, ms);</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">@spawnat</span> <span class="fl">4</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, ms, ms);</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>pre <span class="op">=</span> <span class="fu">DArray</span>([d1 d2 d3]);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here is the entire parallel code:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode jl code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="fl">3</span>    <span class="co"># number of domains and processes</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="fl">21</span>   <span class="co"># total number of points; must be a multiple of N</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@assert</span> m<span class="op">%</span>N <span class="op">==</span> <span class="fl">0</span> <span class="st">"m must be a multiple of N"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>ms <span class="op">=</span> <span class="fu">round</span>(<span class="dt">Int</span>, m<span class="op">/</span>N)   <span class="co"># the size of each subdomain</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> (m<span class="op">-</span><span class="fl">1</span>)        <span class="co"># grid spacing</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributed</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">addprocs</span>(N)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">DistributedArrays</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>U <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);     <span class="co"># 0th iteration; a distributed 2D array</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);   <span class="co"># work area array</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>dU <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);    <span class="co"># update array</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>F <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);   <span class="co"># RHS; a distributed 2D array</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">fillF</span>(data,m,h)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> <span class="fu">localindices</span>(data)[<span class="fl">1</span>]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iGlobal <span class="kw">in</span> rows</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        iLoc <span class="op">=</span> iGlobal <span class="op">-</span> rows.start <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> iGlobal <span class="op">&gt;=</span> <span class="fu">trunc</span>(<span class="dt">Int</span>,m<span class="op">/</span><span class="fl">2</span>)<span class="op">-</span><span class="fl">3</span> <span class="op">&amp;&amp;</span> iGlobal <span class="op">&lt;=</span> <span class="fu">trunc</span>(<span class="dt">Int</span>,m<span class="op">/</span><span class="fl">2</span>)<span class="op">+</span><span class="fl">3</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc] <span class="op">=</span> h<span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="fl">1.0</span>;</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> w <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@spawnat</span> w <span class="fu">fillF</span>(F, m, h)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>pre <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Float64</span>, ms, m);</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">fillPre</span>(data, rank, ms, N)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rank <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        data.localpart[<span class="fl">1</span>,<span class="fl">1</span>] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>ms   <span class="co"># main diagonal</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc,iLoc] <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">3</span><span class="op">:</span>ms   <span class="co"># above main diagonal</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc<span class="op">-</span><span class="fl">1</span>,iLoc] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms<span class="op">-</span><span class="fl">1</span>   <span class="co"># below main diagonal</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc<span class="op">+</span><span class="fl">1</span>,iLoc] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rank <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> rank <span class="op">&lt;</span> N</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms   <span class="co"># main diagonal</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc,iLoc] <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>ms   <span class="co"># above main diagonal</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc<span class="op">-</span><span class="fl">1</span>,iLoc] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms<span class="op">-</span><span class="fl">1</span>   <span class="co"># below main diagonal</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc<span class="op">+</span><span class="fl">1</span>,iLoc] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rank <span class="op">==</span> N</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        data.localpart[ms,ms] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms<span class="op">-</span><span class="fl">1</span>   <span class="co"># main diagonal</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc,iLoc] <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>ms   <span class="co"># above main diagonal</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc<span class="op">-</span><span class="fl">1</span>,iLoc] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms<span class="op">-</span><span class="fl">2</span>   <span class="co"># below main diagonal</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>            data.localpart[iLoc<span class="op">+</span><span class="fl">1</span>,iLoc] <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (rank,w) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">workers</span>())</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@spawnat</span> w <span class="fu">fillPre</span>(pre, rank, ms, N)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">invertPre</span>(data)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    data.localpart <span class="op">=</span> <span class="fu">inv</span>(data.localpart)</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># println(data.localpart)</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> w <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@spawnat</span> w <span class="fu">invertPre</span>(pre)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">computeUpdate</span>(data, F, U, ms, rank, N, tmp, dU)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (1) compute tmp = (F-A*U)</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rank <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>        tmp.localpart[<span class="fl">1</span>] <span class="op">=</span> F.localpart[<span class="fl">1</span>] <span class="op">-</span> U[<span class="fl">1</span>]</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for rank==1 we always have iGlobal = iLoc</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>ms</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>            tmp.localpart[iLoc] <span class="op">=</span> F.localpart[iLoc] <span class="op">+</span> U[iLoc<span class="op">-</span><span class="fl">1</span>] <span class="op">-</span> <span class="fl">2</span><span class="op">*</span>U[iLoc] <span class="op">+</span> U[iLoc<span class="op">+</span><span class="fl">1</span>] <span class="co"># last one has U[ms+1] =&gt; domains communicate</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rank <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> rank <span class="op">&lt;</span> N</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        iGlobal <span class="op">=</span> (rank<span class="op">-</span><span class="fl">1</span>)<span class="op">*</span>ms</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>            iGlobal <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>            tmp.localpart[iLoc] <span class="op">=</span> F.localpart[iLoc] <span class="op">+</span> U[iGlobal<span class="op">-</span><span class="fl">1</span>] <span class="op">-</span> <span class="fl">2</span><span class="op">*</span>U[iGlobal] <span class="op">+</span> U[iGlobal<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rank <span class="op">==</span> N</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        iGlobal <span class="op">=</span> (rank<span class="op">-</span><span class="fl">1</span>)<span class="op">*</span>ms</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iLoc <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>ms<span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            iGlobal <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>            tmp.localpart[iLoc] <span class="op">=</span> F.localpart[iLoc] <span class="op">+</span> U[iGlobal<span class="op">-</span><span class="fl">1</span>] <span class="op">-</span> <span class="fl">2</span><span class="op">*</span>U[iGlobal] <span class="op">+</span> U[iGlobal<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>        tmp.localpart[ms] <span class="op">=</span> F.localpart[ms] <span class="op">-</span> U[rank<span class="op">*</span>ms]</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (2) compute pre*tmp</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    dU.localpart <span class="op">=</span> data.localpart<span class="op">*</span>tmp.localpart</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rank <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(<span class="fu">norm</span>(dU.localpart))</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">addUpdate</span>(U, dU)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    U.localpart <span class="op">+=</span> dU.localpart</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">LinearAlgebra</span>: norm</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> iter <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">for</span> (rank,w) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">workers</span>())</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@spawnat</span> w <span class="fu">computeUpdate</span>(pre, F, U, ms, rank, N, tmp, dU)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">for</span> w <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@spawnat</span> w <span class="fu">addUpdate</span>(U, dU)</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>Ulocal <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float64</span>, m, <span class="fl">1</span>);</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>Ulocal <span class="op">.=</span> U</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fl">1</span><span class="op">:</span>m, Ulocal, label<span class="op">=</span><span class="st">"approximate"</span>)</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a><span class="fu">savefig</span>(<span class="st">"parallel.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>Ulocal</code> is necessary since the <code>plot()</code> function <strong>won’t take the distributed array</strong> <code>U</code> as an argument.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>“An Introduction to Domain Decomposition Methods” by Victorita Dolean, Pierre Jolivet, and Frédéric Nataf<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>“An Introduction to Domain Decomposition Methods” by Victorita Dolean, Pierre Jolivet, and Frédéric Nataf<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/folio\.vastcloud\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>