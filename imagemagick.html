<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Command-line image processing with ImageMagick – Various courses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-befe23ebd2f54d8af2c8a89d1a1611f1.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-1d547202ef5b81858b5cd4b4ce92205d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-eac55d546c0ca4dc023391fb17064d7a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-1d547202ef5b81858b5cd4b4ce92205d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#basic-usage" id="toc-basic-usage" class="nav-link" data-scroll-target="#basic-usage">Basic usage</a></li>
  <li><a href="#resizing" id="toc-resizing" class="nav-link" data-scroll-target="#resizing">Resizing</a></li>
  <li><a href="#cropping-and-regions" id="toc-cropping-and-regions" class="nav-link" data-scroll-target="#cropping-and-regions">Cropping and regions</a></li>
  <li><a href="#whole-image-transforms" id="toc-whole-image-transforms" class="nav-link" data-scroll-target="#whole-image-transforms">Whole-image transforms</a></li>
  <li><a href="#in-place-and-batch-processing" id="toc-in-place-and-batch-processing" class="nav-link" data-scroll-target="#in-place-and-batch-processing">In-place and batch processing</a></li>
  <li><a href="#joining-images" id="toc-joining-images" class="nav-link" data-scroll-target="#joining-images">Joining images</a>
  <ul class="collapse">
  <li><a href="#joining-horizontally" id="toc-joining-horizontally" class="nav-link" data-scroll-target="#joining-horizontally">Joining horizontally:</a></li>
  <li><a href="#joining-vertically" id="toc-joining-vertically" class="nav-link" data-scroll-target="#joining-vertically">Joining vertically:</a></li>
  <li><a href="#automating-these-with-bash-functions" id="toc-automating-these-with-bash-functions" class="nav-link" data-scroll-target="#automating-these-with-bash-functions">Automating these with bash functions</a></li>
  <li><a href="#d-joining" id="toc-d-joining" class="nav-link" data-scroll-target="#d-joining">2D joining</a></li>
  <li><a href="#adding-images-to-a-new-canvas" id="toc-adding-images-to-a-new-canvas" class="nav-link" data-scroll-target="#adding-images-to-a-new-canvas">Adding images to a new canvas</a></li>
  </ul></li>
  <li><a href="#drawing" id="toc-drawing" class="nav-link" data-scroll-target="#drawing">Drawing</a>
  <ul class="collapse">
  <li><a href="#basic-shapes" id="toc-basic-shapes" class="nav-link" data-scroll-target="#basic-shapes">Basic shapes</a></li>
  <li><a href="#text" id="toc-text" class="nav-link" data-scroll-target="#text">Text</a></li>
  </ul></li>
  <li><a href="#working-with-channels" id="toc-working-with-channels" class="nav-link" data-scroll-target="#working-with-channels">Working with channels</a></li>
  <li><a href="#replacing-colours-in-place" id="toc-replacing-colours-in-place" class="nav-link" data-scroll-target="#replacing-colours-in-place">Replacing colours in-place</a></li>
  <li><a href="#display" id="toc-display" class="nav-link" data-scroll-target="#display">Display</a></li>
  <li><a href="#other" id="toc-other" class="nav-link" data-scroll-target="#other">Other</a></li>
  <li><a href="#links" id="toc-links" class="nav-link" data-scroll-target="#links">Links</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Command-line image processing with ImageMagick</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>January 9th, 2024</strong></p>
<p>You can find this page at &nbsp; <span style="font-size:1.8em;">https://folio.vastcloud.org/imagemagick</span></p>
<!-- Abstract: ImageMagick is an open-source tool for manipulating images. You can use it to convert images between -->
<!-- different formats, including JPEG, PNG, PDF, AVIF, TIFF and many others. ImageMagick can also resize, rotate, -->
<!-- crop, and transform images, adjust colours, apply special effects, and draw basic shapes. First released in -->
<!-- 1990, ImageMagick has grown to include hundreds of features. It runs on Linux, Mac, Windows, and is also -->
<!-- available on the Alliance clusters. In this webinar I will try to help you navigate ImageMagick's myriad of -->
<!-- functions by showing some command-line workflows most common in scientific research. -->
<ul>
<li>Open-source and multi-platform</li>
<li>Created by John Cristy in 1987</li>
<li>Understands 200+ image file formats</li>
<li>Available as a <em>command line tool</em> and <em>via APIs</em> for various languages: PythonMagick, RMagick, ImageMagick.jl, Magick++, and many others
<ul>
<li>for details see https://imagemagick.org/script/develop.php</li>
</ul></li>
<li>Latest version 7.1.1</li>
</ul>
<p>What we are not covering today: - APIs - GraphicsMagick (fork of ImageMagick) - Using ImageMagick for animations – for that I recommend <code>ffmpeg</code> - More complex workflows (layers, mathematical algorithms, …)</p>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<p>Binary packages for Linux/Mac/Windows are available from https://imagemagick.org/script/download.php, or you can compile from source. On a Mac you can use <code>brew</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install ghostscript   <span class="co"># Ghostscript fonts needed for ImageMagick</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install imagemagick</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the Alliance clusters, as of this writing, ImageMagick 7.0.10-7 is part of gentoo/2020 (loaded by default). I’ll run a demo on Cedar at the very end of this workshop.</p>
</section>
<section id="basic-usage" class="level2">
<h2 class="anchored" data-anchor-id="basic-usage">Basic usage</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> tool [ {option} <span class="kw">|</span> <span class="ex">{image}</span> ... ] {output_image}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>&lt;tool&gt;</code> is one of the 11 commands: <code>animate</code>, <code>compare</code>, <code>composite</code>, <code>conjure</code>, <code>convert</code>, <code>display</code>, <code>identify</code>, <code>import</code>, <code>mogrify</code>, <code>montage</code>, <code>stream</code>. I’ll show where to find this list in a few minutes.</p>
<p>Starting with version 6, the operators (options) will always be applied in the command line order given by the user.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> convert ...      <span class="co"># full version of a command</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> ...             <span class="co"># shorter version of the same command</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> {options} ...    <span class="co"># occasionally we will use this syntax</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s start with a very simple example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> https://images.pexels.com/photos/35600/road-sun-rays-path.jpg forest.jpg</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">identify</span> forest.jpg</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">identify</span> <span class="at">-verbose</span> forest.jpg   <span class="co"># a lot more additional information</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">identify</span> <span class="at">-format</span> <span class="st">'%f %wx%h %[channels] %[bit-depth]-bit %Q\n'</span> forest.jpg   <span class="co"># only specific fields</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here we are showing the filename (<code>%f</code>), image’s width and height (<code>%wx%h</code>), colour space and the number of channels (<code>%[channels]</code>), its bit depth(<code>%[bit-depth]</code>), and the compression quality (<code>%Q</code>). More details on the <code>-format</code> option at https://imagemagick.org/script/escape.php</p>
<p>You might find it useful to define an alias:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">alias</span> size=<span class="st">"identify -format '%f %wx%h\n'"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">size</span> forest.jpg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.jpg forest.png</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-list</span> format   <span class="co"># see the list of support image formats</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.jpg forest.avif   <span class="co"># modern open-source image format released in 2019-Feb</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="co"># by the Alliance for Open Media (lossless and lossy)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.jpg forest.webp   <span class="co"># Google's open-source format from 2011 (lossless and lossy)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- AVIF and WEBP details at https://www.smashingmagazine.com/2021/09/modern-image-formats-avif-webp -->
<!-- https://avif.io/blog/tutorials/imagemagick -->
<div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-l</span> <span class="va">$(</span><span class="fu">which</span> convert<span class="va">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span> convert <span class="kw">|</span> <span class="fu">xargs</span> realpath <span class="kw">|</span> <span class="fu">xargs</span> dirname <span class="kw">|</span> <span class="fu">xargs</span> ls   <span class="co"># check tools in /opt/homebrew/Cellar/imagemagick/7.1.1-24/bin</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> https://upload.wikimedia.org/wikipedia/commons/2/2c/NZ_Landscape_from_the_van.jpg hills.avif</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> https://upload.wikimedia.org/wikipedia/commons/5/5e/Deserto_libico_-_Driving_-_panoramio.jpg desert.avif</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> https://upload.wikimedia.org/wikipedia/commons/e/e0/Clouds_over_the_Atlantic_Ocean.jpg ocean.avif</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">man</span> convert   <span class="co"># over a 100 flags! convert + resize, blur, crop, despeckle, dither, draw on, flip, join, re-sample, and much more</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice that the manual page also links to the offline (local file) HTML-formatted documentation:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> file:///opt/homebrew/Cellar/imagemagick/7.1.1-24/share/doc/ImageMagick-7/www/convert.html</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="resizing" class="level2">
<h2 class="anchored" data-anchor-id="resizing">Resizing</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-resize</span> 50% f1.avif</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-resize</span> 50%           <span class="co"># keep the aspect ratio</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-resize</span> 1600x1600     <span class="co"># convert to 1600x1067 keeping the aspect ratio, i.e. keep each side 1600 or smaller</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-resize</span> 1600x1600<span class="dt">\!</span>   <span class="co"># same and then stretch to 1600x1600</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-resize</span> 1600x         <span class="co"># convert to 1600x1067 (specify width)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">-resize</span> x1600         <span class="co"># convert to 2400x1600 (specify height)</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">-resize</span> 50% <span class="at">-grayscale</span> Rec709Luminance   <span class="co"># example of using two flags; use Rec709Luminance grayscale</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="cropping-and-regions" class="level2">
<h2 class="anchored" data-anchor-id="cropping-and-regions">Cropping and regions</h2>
<p>To crop to a single smaller image, you must specify an offset:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-crop</span> 500x500+800+1050 f1.avif   <span class="co"># crop a 500x500 region at a specific offset</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-crop</span> +800+1050 f1.avif   <span class="co"># crop starting at an offset to the lower right corner</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-crop</span> 2656x1254+0+0 f1.avif   <span class="co"># crop from the upper left corner to +2656+1254</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Take-home exercise
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Write a bash script to crop ten random 500x500 images out of <code>forest.avif</code>. There is a solution somewhere <a href="./pytables">on this page</a>, but check it only after you write your own script.</p>
</div>
</div>
</div>
<p>Without an offset, <code>crop</code> will segment the original image:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-crop</span> 30%x100% forest.avif pieces.png    <span class="co"># crop the image into 30%+30%+30%+10% pieces</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-crop</span> 30%x100% forest.avif pieces.avif   <span class="co"># all four images get written to one AVIF</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-crop</span> 30% forest.avif pieces.avif        <span class="co"># will use 30%+30%+30%+10% in both dimensions =&gt; 16 images</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-crop</span> 512x512 forest.avif pieces.avif    <span class="co"># crop into 512x512 pieces =&gt; 35 images</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-crop</span> 512x forest.avif pieces.avif       <span class="co"># crop horizontally only =&gt; 7 images</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can apply operators to a portion of an image:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-negate</span> f1.avif   <span class="co"># negate the entire image</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-gravity</span> Center <span class="at">-region</span> 300x300 <span class="at">-negate</span> f1.avif   <span class="co"># negate a 300x300 region</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                                                             <span class="co"># in the center (order is important!)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                             <span class="ex">NorthEast</span>                       <span class="co"># upper right corner</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-list</span> gravity                                        <span class="co"># list all 11 options</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-region</span> 300x300+1600+100 <span class="at">-blur</span> 0,10 f1.avif   <span class="co"># specify exact position; blur {radius}x{sigma}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>How do we blur an entire image?</p>
</div>
</div>
</div>
</section>
<section id="whole-image-transforms" class="level2">
<h2 class="anchored" data-anchor-id="whole-image-transforms">Whole-image transforms</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">-flip</span>        <span class="co"># vertically</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-flop</span>        <span class="co"># horizontally</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-rotate</span> 90   <span class="co"># could be any number, not just 90/180/270 - will introduce borders</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-transpose</span>   <span class="co"># flip vertically + rotate 90 degrees</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-transverse</span>  <span class="co"># flip horizontally + rotate 270 degrees</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">-border</span> 10   <span class="co"># surround the image with a light gray border of width=10 on all four sides</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ex">-bordercolor</span> yellow <span class="at">-border</span> 10    <span class="co"># same, with yellow border (order is important!)</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> Screenshot<span class="pp">*</span>.png <span class="at">-transparent</span> white <span class="at">-fuzz</span> 3% f1.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="in-place-and-batch-processing" class="level2">
<h2 class="anchored" data-anchor-id="in-place-and-batch-processing">In-place and batch processing</h2>
<p>The command <code>mogrify</code> is similar to <code>convert</code>, but it overwrites the original image by default (in-place processing), so it can be used on a batch of images.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-resize</span> 80% ocean.avif        <span class="co"># overwrite the original</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-format</span> png <span class="at">-resize</span> 1000x <span class="at">-depth</span> 8 <span class="pp">*</span>.avif   <span class="co"># convert all AVIFs to 8-bit colour 1000x PNGs</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> ~/talks/2024/01a-imagemagick/hybridParallelism.svg .</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-background</span> <span class="st">"#d3d3d3"</span> <span class="at">-format</span> png hybridParallelism.svg   <span class="co"># set the background color</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-transparent</span> <span class="st">"#d3d3d3"</span> hybridParallelism.png              <span class="co"># make the background transparent</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-background</span> none <span class="at">-format</span> png hybridParallelism.svg        <span class="co"># PNG without a background</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The end result is the same in both cases (<code>-transparent "#d3d3d3"</code> and <code>-background none</code>), but the image with the transparent background has more information in it (check with <code>ls -l</code>) which is hidden by the alpha (opacity) channel. We’ll explore this when we talk about channels.</p>
</section>
<section id="joining-images" class="level2">
<h2 class="anchored" data-anchor-id="joining-images">Joining images</h2>
<section id="joining-horizontally" class="level3">
<h3 class="anchored" data-anchor-id="joining-horizontally">Joining horizontally:</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">size</span> desert.avif forest.avif</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">montage</span> <span class="at">-geometry</span> x1200 desert.avif forest.avif mosaic1.avif   <span class="co"># create a composite image from two AVIFs</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> x1200 desert.avif forest.avif +append mosaic2.avif   <span class="co"># same but without a gap</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> x1200 <span class="at">-border</span> 30 desert.avif forest.avif +append mosaic2.avif   <span class="co"># add border around each image</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-trim</span> mosaic2.avif   <span class="co"># trim at the end (removes any edges of the same color as the corner pixels)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The flag <code>-trim</code> does not work very well in this two-step process. You can get better results by combining the last two commands into one:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> x1200 <span class="at">-border</span> 30 desert.avif forest.avif +append <span class="at">-trim</span> mosaic2.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here processing happens from left to right.</p>
</section>
<section id="joining-vertically" class="level3">
<h3 class="anchored" data-anchor-id="joining-vertically">Joining vertically:</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> 1200x desert.avif forest.avif <span class="at">-append</span> mosaic2.avif   <span class="co"># merge vertically without a gap</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> 1200x <span class="at">-border</span> 10 desert.avif forest.avif <span class="at">-append</span> mosaic2.avif   <span class="co"># merge with a border around each image</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-shave</span> 10x10 mosaic2.avif   <span class="co"># remove the outer border; more reliable than -trim</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> 1200x <span class="at">-border</span> 10 desert.avif forest.avif <span class="at">-append</span> <span class="at">-shave</span> 10x10 mosaic2.avif <span class="co"># combine the two commands into one</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="automating-these-with-bash-functions" class="level3">
<h3 class="anchored" data-anchor-id="automating-these-with-bash-functions">Automating these with bash functions</h3>
<p>I find it difficult to remember all this syntax, so I like automating these commands with functions, e.g.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> mergeImagesVertically()</span> <span class="kw">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="va">$#</span> <span class="ot">==</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> Usage: mergeImagesVertically <span class="at">-o</span> outputImage sharedSideSize inputImage1 inputImage2 ...</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">size</span><span class="op">=</span><span class="va">$3</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">output</span><span class="op">=</span><span class="va">$2</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">shift</span> 3</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">convert</span> <span class="at">-geometry</span> <span class="va">${size}</span>x <span class="va">$@</span> <span class="at">-append</span> <span class="va">$output</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> mergeImagesHorizontally()</span> <span class="kw">{</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="va">$#</span> <span class="ot">==</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> Usage: mergeImagesHorizontally <span class="at">-o</span> outputImage sharedSideSize inputImage1 inputImage2 ...</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">size</span><span class="op">=</span><span class="va">$3</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">output</span><span class="op">=</span><span class="va">$2</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">shift</span> 3</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">convert</span> <span class="at">-geometry</span> x<span class="va">${size}</span> <span class="va">$@</span> +append <span class="va">$output</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then the command</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> 1200x desert.avif forest.avif <span class="at">-append</span> mosaic2.avif   <span class="co"># merge vertically without a gap</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>becomes</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mergeImagesVertically</span> <span class="at">-o</span> mosaic2.avif 1200 desert.avif forest.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="d-joining" class="level3">
<h3 class="anchored" data-anchor-id="d-joining">2D joining</h3>
<p>Let’s create a 2x2 mosaic with a gap between images:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> 1200x <span class="at">-border</span> 10 desert.avif forest.avif <span class="at">-append</span> <span class="at">-shave</span> 10x10 mosaic1.avif</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> 1200x <span class="at">-border</span> 10 hills.avif ocean.avif <span class="at">-append</span> <span class="at">-shave</span> 10x10 mosaic2.avif</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">identify</span> mosaic<span class="dt">{1</span><span class="op">,</span><span class="dt">2}</span>.avif</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-geometry</span> x1620 <span class="at">-border</span> 10 mosaic<span class="dt">{1</span><span class="op">,</span><span class="dt">2}</span>.avif +append <span class="at">-shave</span> 10x10 mosaic3.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alternatively, you can create a 2x2 mosaic in one command with montage</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">montage</span> <span class="at">-geometry</span> x1200 desert.avif forest.avif hills.avif ocean.avif mosaic4.avif   <span class="co"># all the same height</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">montage</span> <span class="at">-geometry</span> 1200x desert.avif forest.avif hills.avif ocean.avif mosaic4.avif   <span class="co"># all the same width</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">montage</span> <span class="at">-geometry</span> 1200x1200 desert.avif forest.avif hills.avif ocean.avif mosaic4.avif <span class="co"># still all the same width; wider gaps</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ex">montage</span> <span class="at">-geometry</span> 1200x1200<span class="dt">\!</span> desert.avif forest.avif hills.avif ocean.avif mosaic4.avif   <span class="co"># all stretched to same size</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I much prefer mosaic3.avif, as it (1) keeps all original aspect ratios and (2) does not waste space.</p>
</section>
<section id="adding-images-to-a-new-canvas" class="level3">
<h3 class="anchored" data-anchor-id="adding-images-to-a-new-canvas">Adding images to a new canvas</h3>
<p>Let’s place <code>desert.avif</code> into a new 520x300 canvas:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> desert.avif <span class="at">-resize</span> 10% <span class="at">-gravity</span> center <span class="at">-background</span> white <span class="at">-extent</span> 520x300 overlap.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alternatively, you can obtain exactly the same result with a border:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> desert.avif <span class="at">-resize</span> 10% <span class="at">-bordercolor</span> white <span class="at">-border</span> 51x37 overlap.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now let’s add a second image using <code>\\( ... \\)</code> to apply resize only to the second image:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> overlap.avif <span class="dt">\(</span> forest.avif <span class="at">-resize</span> 100x100 <span class="dt">\)</span> <span class="at">-gravity</span> northeast <span class="at">-composite</span> overlap.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Without <code>\\( ... \\)</code> the flag <code>-resize 100x100</code> would apply to both images.</p>
</div>
</div>
<p>Alternatively, we can start with an empty canvas and add images one-by-one:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 520x300 canvas:skyblue overlap.avif  <span class="co"># create an empty canvas</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> overlap.avif <span class="dt">\(</span> desert.avif <span class="at">-resize</span> 10% <span class="dt">\)</span> <span class="at">-gravity</span> center <span class="at">-composite</span> overlap.avif</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> overlap.avif <span class="dt">\(</span> forest.avif <span class="at">-resize</span> 100x100 <span class="dt">\)</span> <span class="at">-gravity</span> northeast <span class="at">-composite</span> overlap.avif</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> overlap.avif <span class="dt">\(</span> ocean.avif <span class="at">-resize</span> 100x100 <span class="dt">\)</span> <span class="at">-geometry</span> +100+220 <span class="at">-composite</span> overlap.avif <span class="co"># use -geometry for position</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> overlap.avif hills.avif <span class="at">-geometry</span> 100x100+250+220 <span class="at">-composite</span> overlap.avif   <span class="co"># use -geometry for both size and position</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The flag <code>-geometry 100x100+250+220</code> applies only to the preceding (second) image, so no need for the brackets.</p>
</section>
</section>
<section id="drawing" class="level2">
<h2 class="anchored" data-anchor-id="drawing">Drawing</h2>
<section id="basic-shapes" class="level3">
<h3 class="anchored" data-anchor-id="basic-shapes">Basic shapes</h3>
<p>Drawing falls into more advanced ImageMagick usage, and it can get complicated very quickly. Here I will show just a few shorter commands. For more examples see https://imagemagick.org/Usage/draw.</p>
<p>In these examples <code>xc:&lt;colour&gt;</code> produces a window fill colour:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 500x300 xc:skyblue empty.avif   <span class="co"># recall: creates an empty canvas</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 500x300 xc:skyblue <span class="at">-fill</span> blue <span class="at">-stroke</span> black <span class="at">-strokewidth</span> 5 <span class="dt">\</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"line 180,180 390,170"</span> <span class="at">-draw</span> <span class="st">"line 160,130 370,210"</span> drawing.avif</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 500x300 xc:skyblue <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="dt">\</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"                    rectangle  25,50  75,250 "</span> <span class="dt">\</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"fill-opacity 0.8    rectangle 100,50 150,250 "</span> <span class="dt">\</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"fill-opacity 0.6    rectangle 175,50 225,250 "</span> <span class="dt">\</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"fill-opacity 0.4    rectangle 250,50 300,250 "</span> <span class="dt">\</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"fill-opacity 0.2    rectangle 325,50 375,250 "</span> <span class="dt">\</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"fill-opacity  0     rectangle 400,50 450,250 "</span> <span class="dt">\</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>       drawing.avif</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 500x300 xc:skyblue <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="dt">\</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"path 'M 200,50 100,250 450,50 350,200 Z'"</span> drawing.avif <span class="co"># M starts the path, Z closes it</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 500x300 xc:skyblue <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="dt">\</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">-draw</span> <span class="st">"fill-rule evenodd </span><span class="dt">\</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="st">                 path 'M 200,50 100,100 350,250 Z</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="st">                       M 100,200 350,200 450,50 Z</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="st">                       M 230,270 290,60 310,250 Z'"</span> drawing.avif</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-list</span> fill-rule</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 500x300 xc:skyblue <span class="at">-fill</span> white <span class="at">-draw</span> <span class="st">'circle 250,150 250,50'</span> drawing.avif <span class="co"># centre and a point on the circumference</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="text" class="level3">
<h3 class="anchored" data-anchor-id="text">Text</h3>
<p>Now let’s try adding text to images. First, check the available fonts:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-list</span> font   <span class="co"># list all fonts, 2171 on my laptop</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The flag <code>-pointsize &lt;size&gt;</code> below sets the font size. Let’s pick one of the fonts:</p>
<!-- https://imagemagick.org/Usage/text/#coloring_text -->
<div class="sourceCode" id="cb29"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 700x300 xc:#71928C <span class="at">-draw</span> <span class="st">'text 100,200  "Hello!"'</span> hello.avif</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 700x300 xc:#71928C <span class="at">-pointsize</span> 210 <span class="at">-font</span> Times-New-Roman-Italic <span class="dt">\</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="at">-strokewidth</span> 2 <span class="at">-draw</span> <span class="st">'text 100,200  "Hello!"'</span> hello.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that the order of the flags is very important here!</p>
<p>We can also compare multiple fonts:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> font <span class="kw">in</span> AvantGarde-Book AvantGarde-BookOblique AvantGarde-Demi <span class="dt">\</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                            AvantGarde-DemiOblique Bookman-Demi<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">magick</span> <span class="at">-size</span> 1200x120 xc:lightblue  <span class="at">-pointsize</span> 50 <span class="at">-font</span> <span class="va">$font</span> <span class="dt">\</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">-fill</span> black <span class="at">-draw</span> <span class="st">"text 30,80 'Hello! with </span><span class="va">$font</span><span class="st">'"</span> font-<span class="va">${font}</span>.avif</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> font<span class="pp">*</span>.avif <span class="at">-append</span> someFonts.avif</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-list</span> font <span class="kw">|</span> <span class="fu">grep</span> <span class="st">"Font:"</span> <span class="op">&gt;</span> fonts.txt</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> font <span class="kw">in</span> <span class="va">$(</span><span class="fu">awk</span> <span class="at">-F</span><span class="st">": "</span> <span class="st">'{print $2}'</span> fonts.txt <span class="va">)</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">magick</span> <span class="at">-size</span> 1200x120 xc:lightblue  <span class="at">-pointsize</span> 50 <span class="at">-font</span> <span class="va">$font</span> <span class="dt">\</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">-fill</span> black <span class="at">-draw</span> <span class="st">"text 30,80 'Hello! with </span><span class="va">$font</span><span class="st">'"</span> font-<span class="va">${font}</span>.avif</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 680x950 xc:#71928C <span class="at">-pointsize</span> 180 <span class="at">-font</span> Apple-Chancery <span class="dt">\</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">-fill</span> white <span class="at">-stroke</span> none                 <span class="at">-draw</span> <span class="st">'text 30,180  "Stroke -"'</span> <span class="dt">\</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="at">-strokewidth</span> 0 <span class="at">-draw</span> <span class="st">'text 30,360 "Stroke 0"'</span> <span class="dt">\</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="at">-strokewidth</span> 2 <span class="at">-draw</span> <span class="st">'text 30,540 "Stroke 2"'</span> <span class="dt">\</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="at">-strokewidth</span> 4 <span class="at">-draw</span> <span class="st">'text 30,720 "Stroke 4"'</span> <span class="dt">\</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">-fill</span> white <span class="at">-stroke</span> black <span class="at">-strokewidth</span> 6 <span class="at">-draw</span> <span class="st">'text 30,900 "Stroke 6"'</span> <span class="dt">\</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>      strokes.jpg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>How about adding text to an existing image?</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">identify</span> <span class="at">-format</span> <span class="st">'%wx%h\n'</span> forest.avif   <span class="co"># get the size</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-pointsize</span> 60 <span class="at">-fill</span> white <span class="at">-font</span> Apple-Chancery <span class="at">-draw</span> <span class="st">"text 3100,2250 'forest road'"</span> f1.avif</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-pointsize</span> 60 <span class="at">-fill</span> white <span class="at">-gravity</span> southeast <span class="at">-annotate</span> 0 <span class="st">"forest road"</span> f1.avif <span class="co"># 0 is rotation in degrees</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="working-with-channels" class="level2">
<h2 class="anchored" data-anchor-id="working-with-channels">Working with channels</h2>
<!-- https://imagemagick.org/Usage/color_basics -->
<!-- https://imagemagick.org/Usage/masking -->
<!-- file:///opt/homebrew/Cellar/imagemagick/7.1.1-24/share/doc/ImageMagick-7/www/compose.html -->
<p>Start with some large text on a canvas, and add a smaller line with a different colour:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> <span class="at">-size</span> 700x300 xc:#71928C <span class="at">-pointsize</span> 210 <span class="at">-font</span> Times-New-Roman-Italic <span class="dt">\</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">-fill</span> white <span class="at">-draw</span> <span class="st">'text 100,200 "Hello!"'</span> hello.png</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">magick</span> hello.png <span class="at">-pointsize</span> 40 <span class="at">-fill</span> <span class="st">"#71739C"</span> <span class="at">-draw</span> <span class="st">'text 100,260 "This text will be hidden."'</span> hello.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Make the background transparent – this will also apply to the smaller line:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-transparent</span> <span class="st">"#71928C"</span> <span class="at">-fuzz</span> 10% hello.png helloTransparent.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, we overlay over a checked background; <code>dst_over</code> means “destination is composited over the source”:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">composite</span> <span class="at">-compose</span> dst_over <span class="at">-tile</span> pattern:checkerboard helloTransparent.png helloChecked.png   <span class="co"># no hidden text</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The hidden text is still present in the transparent image, even though you cannot see it. Let’s turn the alpha channel off in the transparent image:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-alpha</span> off alphaOff.png   <span class="co"># hidden text still there; transparency data not in alphaOff.png</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png helloTransparent.jpg    <span class="co"># JPG does not support transparency; so the hidden text is there</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png helloTransparent.avif <span class="kw">&amp;&amp;</span> <span class="ex">convert</span> helloTransparent.avif <span class="at">-alpha</span> off alphaOff.avif</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>         <span class="co"># AVIF supports transparency; note the AVIF compression of the hidden text!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Extract the alpha channel:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-alpha</span> extract alphaOnly.png   <span class="co"># alpha channel only</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>                             <span class="ex">-channel</span> alpha <span class="at">-separate</span>       <span class="co"># same</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In fact, we can extract any channel from an image:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># separate the alpha+RGB channels</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-channel</span> alpha <span class="at">-separate</span> helloAlpha.avif</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-channel</span> red <span class="at">-separate</span> helloRed.avif</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-channel</span> green <span class="at">-separate</span> helloGreen.avif</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-channel</span> blue <span class="at">-separate</span> helloBlue.avif</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> hello<span class="dt">{Red</span><span class="op">,</span><span class="dt">Green</span><span class="op">,</span><span class="dt">Blue</span><span class="op">,</span><span class="dt">Alpha}</span>.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, recall <code>helloChecked.png</code> (we ran this command earlier):</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">composite</span> <span class="at">-compose</span> dst_over <span class="at">-tile</span> pattern:checkerboard helloTransparent.png helloChecked.png</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-channel</span> alpha <span class="at">-negate</span> h1.png   <span class="co"># negate the alpha channel</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="ex">composite</span> <span class="at">-compose</span> dst_over <span class="at">-tile</span> pattern:checkerboard h1.png helloCheckedReverse.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The image <code>helloTransparent.png</code> has alpha either at 0% or 100% (only two values). Let’s add 75% to alpha (it’ll truncate values over 100%):</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> helloTransparent.png <span class="at">-channel</span> alpha <span class="at">-evaluate</span> add 75% h2.png   <span class="co"># now 75% &lt; alpha &lt; 100%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> hello.png h2.png</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="ex">composite</span> <span class="at">-compose</span> dst_over <span class="at">-tile</span> pattern:checkerboard h2.png helloCheckedPartialTransparency.png</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> helloChecked.png helloCheckedPartialTransparency.png</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-list</span> evaluate   <span class="co"># print all -evaluate operators</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-channel</span> blue <span class="at">-evaluate</span> multiply 0.1 f1.avif   <span class="co"># reduce blue colour by 10X</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> forest.avif <span class="at">-channel</span> red <span class="at">-evaluate</span> set 0 f1.avif           <span class="co"># remove red colour completely</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s superimpose two images with 40% transparency, keeping all original colours:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> ocean.avif <span class="at">-geometry</span> 1600x1000<span class="dt">\!</span> <span class="at">-alpha</span> set <span class="at">-channel</span> A <span class="at">-evaluate</span> set 40% o40.avif</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> desert.avif <span class="at">-geometry</span> 1600x1000<span class="dt">\!</span> <span class="at">-alpha</span> set <span class="at">-channel</span> A <span class="at">-evaluate</span> set 40% d40.avif</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="ex">composite</span> <span class="at">-compose</span> dst_over o40.avif d40.avif oceanDesert.avif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="replacing-colours-in-place" class="level2">
<h2 class="anchored" data-anchor-id="replacing-colours-in-place">Replacing colours in-place</h2>
<p>You can also modify colours without using channels.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-size</span> 500x500 xc:black squares.png                         <span class="co"># empty image</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-fill</span> red <span class="at">-draw</span> <span class="st">"rectangle 0,0 250,250 "</span> squares.png       <span class="co"># add red quadrant</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-fill</span> green <span class="at">-draw</span> <span class="st">"rectangle 251,0 500,250 "</span> squares.png   <span class="co"># add green quadrant</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="ex">mogrify</span> <span class="at">-fill</span> blue <span class="at">-draw</span> <span class="st">"rectangle 0,251 250,500 "</span> squares.png    <span class="co"># add blue quadrant</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> squares.png <span class="at">-fill</span> turquoise <span class="at">-opaque</span> black adjusted.png   <span class="co"># change "opaque" color to "fill" color</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s try the same technique on an actual photo, picking <code>#094C9A</code> (deep blue) colour and changing just those pixels:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> ocean.avif <span class="at">-fill</span> turquoise <span class="at">-opaque</span> <span class="st">"#094C9A"</span> o1.avif</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> ocean.avif <span class="at">-fuzz</span> 10% <span class="at">-fill</span> turquoise <span class="at">-opaque</span> <span class="st">"#094C9A"</span> o1.avif   <span class="co"># widen our colour match</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="display" class="level2">
<h2 class="anchored" data-anchor-id="display">Display</h2>
<p>On MacOS, X11 support is not built into precompiled ImageMagick, so I can’t demo it for you locally on my laptop. I can demo it on Cedar:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> ocean.avif <span class="at">-resize</span> 30% ocean.jpg</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">scp</span> ocean.jpg cedar:</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-X</span> cedar</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="ex">display</span> ocean.jpg   <span class="co"># for this you need an X11 server on your computer (XQuartz on MacOS);</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># click on the image for menu; press Q to quit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="other" class="level2">
<h2 class="anchored" data-anchor-id="other">Other</h2>
<div class="sourceCode" id="cb44"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-size</span> 500x500 xc:white <span class="at">-evaluate</span> gaussian-noise 10 noise.avif    <span class="co"># produce Gaussian noise</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-size</span> 500x500 xc:white <span class="at">-evaluate</span> PoissonNoise 0.01 noise.avif    <span class="co"># produce Poisson noise</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-size</span> 500x500 xc:white <span class="at">-evaluate</span> uniform-noise 1000 noise.avif   <span class="co"># produce uniform noise</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="at">-list</span> color   <span class="co"># list all 678 named colours</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- ## Misc -->
<!-- merge frames -->
<!-- ```sh -->
<!-- wget https://transfer.sh/15kP5b/plotly.tar.gz -->
<!-- unpack it and cd there -->
<!-- # transp='-fuzz 10% -transparent white' -->
<!-- transp='-transparent white' -->
<!-- convert lines.png population.png combine.png citiesByPopulation.png $transp +append -geometry 1600x row1.png -->
<!-- convert network.png bubbles.png parametric.png $transp +append -geometry 1600x row2.png -->
<!-- convert contour.png orthogonal.png isosurface.png $transp +append -geometry 1600x row3.png -->
<!-- convert row{1..3}.png $transp -append thumbs.png -->
<!-- wget https://www.westgrid.ca/files/wesgrid_logo_2016.png -O logo.png -->
<!-- convert logo.png -fuzz 10% -transparent white logoTransparent.png -->
<!-- convert growth.png -fuzz 10% -transparent 'rgb(86,86,86)' growth.png -->
<!-- convert input.jpg -resize 80x80^ -gravity center -extent 80x80 icon.png -->
<!-- mogrify -format jpg -quality 85 *.png   # convert all images -->
<!-- convert $1 -channel RGB -negate $1 -->
<!-- function pdf2jpg -->
<!-- -fx expression -->
<!-- ``` -->
<!-- ## Marie's list -->
<!-- - batch processing -->
<!-- - removing background -->
<!-- - changing background colour -->
<!-- - adding background -->
<!-- - resizing -->
<!-- - pasting images side by side or in a canvas -->
<!-- - cropping -->
<!-- - changing image resolution -->
<!-- - turn pdf to png -->
<!-- - get image size -->
<!-- - add alpha layer -->
<!-- ## GraphicsMagick -->
<!-- brew install GraphicsMagick    # fork of ImageMagick -->
<!-- ```sh -->
<!-- gm               # get help on all commands -->
<!-- gm <command>     # get help on a specific command -->
<!-- wget https://images.pexels.com/photos/35600/road-sun-rays-path.jpg -->
<!-- gm convert road-sun-rays-path.jpg -resize 1600x1600 forest.png -->
<!-- gm convert forest.png forest.jpg -->
<!-- ``` -->
<!-- http://www.graphicsmagick.org/GraphicsMagick.html -->
<!-- - Resize, rotate, sharpen, color reduce, or add special effects to an image -->
<!-- - Create a montage of image thumbnails -->
<!-- - Create a transparent image suitable for use on the Web -->
<!-- - Compare two images -->
<!-- - Turn a group of images into a GIF animation sequence -->
<!-- - Create a composite image by combining several separate images -->
<!-- - Draw shapes or text on an image -->
<!-- - Decorate an image with a border or frame -->
<!-- - Describe the format and characteristics of an image -->
</section>
<section id="links" class="level2">
<h2 class="anchored" data-anchor-id="links">Links</h2>
<ul>
<li><a href="https://usage.imagemagick.org" target="_blank">https://usage.imagemagick.org</a></li>
<li><a href="https://en.wikipedia.org/wiki/ImageMagick" target="_blank">https://en.wikipedia.org/wiki/ImageMagick</a></li>
<li><a href="https://imagemagick.org/script/command-line-tools.php" target="_blank">https://imagemagick.org/script/command-line-tools.php</a></li>
<li><a href="http://www.imagemagick.org/script/command-line-options.php" target="_blank">http://www.imagemagick.org/script/command-line-options.php</a></li>
<li><a href="https://imagemagick.org/script/stream.php" target="_blank">https://imagemagick.org/script/stream.php</a></li>
<li><a href="https://devhints.io/imagemagick" target="_blank">Imagemagick cheatsheet</a></li>
<li><a href="https://github.com/yangboz/imagemagick-cheatsheet" target="_blank">https://github.com/yangboz/imagemagick-cheatsheet</a></li>
</ul>
<!-- - file:///opt/homebrew/Cellar/imagemagick/7.1.1-24/share/doc/ImageMagick-7/www/command-line-options.html -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/folio\.vastcloud\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>